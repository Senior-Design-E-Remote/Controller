//Esp being used is the ESP32-DevKitC-32E
//ESP32 BLE Controller Library: https://github.com/lemmingDev/ESP32-BLE-Gamepad

#include <Arduino.h>
#include <BleGamepad.h>

const int numButtons = 6;

const int leftJoyX = 39;
const int leftJoyY = 36;

const int buttons[numButtons] = {35,32,33,25,26,27}; //A, X, Y, B, Start, Select

const byte buttonNames[numButtons] = {BUTTON_1, BUTTON_2, BUTTON_3, BUTTON_4, BUTTON_5, BUTTON_6};

bool oldButtonStates[numButtons] = {0,0,0,0,0,0};

BleGamepad bleGamepad("E-Remote", "Team 24", 100);

void setup()
{
  Serial.begin(115200);

  for(int i = 0; i < numButtons; i++){ // Initialize all buttons

    pinMode(buttons[i], INPUT_PULLUP);
  }
  BleGamepadConfiguration bleGamepadConfig;
  bleGamepadConfig.setButtonCount(numButtons);
  bleGamepad.begin(&bleGamepadConfig);
  // The default bleGamepad.begin() above enables 16 buttons, all axes, one hat, and no simulation controls or special buttons
}

void loop()
{   
    if (bleGamepad.isConnected())
    {
        for(int i = 0; i < numButtons; i++){ //Set button values
          bool buttonState = digitalRead(buttons[i]);
          if(oldButtonStates[i] != buttonState){ //Only send new signal if button state changed
            oldButtonStates[i] = buttonState;
            if(buttonState){
              bleGamepad.press(buttonNames[i]);
              Serial.print("Button ");
              Serial.print(i);
              Serial.println(" Pressed");
            }          
            else{
              bleGamepad.release(buttonNames[i]);
              Serial.print("Button ");
              Serial.print(i);
              Serial.println(" Unpressed");           
            }
          }
        }

        //Set Joystick Values. Note: Joysticks need 3.3V?

        int leftX = 0;
        int leftY = 0;

        for(int i = 0; i < 10; i++){ //sum 10 readings
          leftX += analogRead(leftJoyX);
          leftY += analogRead(leftJoyY);
        }
        // get average of 10 readings and map them to Joystick range
        leftX /= 10;
        leftY /= 10;

        // if(digitalRead(27)){
        //   Serial.print("Premap X: ");
        //   Serial.print(leftX);
        //   Serial.print(", Premap Y: ");
        //   Serial.println(leftY);
        // }

        leftX = map(leftX, 0, 4095, 0, 32767);
        leftY = map(leftY, 0, 4095, 0, 32767);

        // if(digitalRead(27)){
        //   Serial.print("X: ");
        //   Serial.print(leftX);
        //   Serial.print(", Y: ");
        //   Serial.println(leftY);
        // }
        
        bleGamepad.setX(leftX);
        bleGamepad.setY(leftY);
    }
}
